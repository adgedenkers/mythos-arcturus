<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mythos — Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0a0e17;
  --bg-card: #111827;
  --bg-hover: #1a2332;
  --border: #1e293b;
  --border-light: #293548;
  --text: #e2e8f0;
  --text-dim: #64748b;
  --text-muted: #475569;
  --green: #22c55e;
  --green-bg: rgba(34,197,94,0.08);
  --red: #ef4444;
  --red-bg: rgba(239,68,68,0.08);
  --amber: #f59e0b;
  --amber-bg: rgba(245,158,11,0.08);
  --blue: #3b82f6;
  --blue-bg: rgba(59,130,246,0.08);
  --cyan: #06b6d4;
  --cyan-bg: rgba(6,182,212,0.08);
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  background: var(--bg);
  color: var(--text);
  font-family: 'DM Sans', sans-serif;
  font-size: 14px;
  line-height: 1.5;
}
.mono { font-family: 'JetBrains Mono', monospace; }

/* Top bar */
.topbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 24px;
  border-bottom: 1px solid var(--border);
  background: var(--bg-card);
}
.topbar-left {
  display: flex;
  align-items: center;
  gap: 20px;
}
.topbar .logo {
  font-family: 'JetBrains Mono', monospace;
  font-size: 18px;
  font-weight: 500;
  letter-spacing: 3px;
  color: var(--cyan);
}
.topbar-nav {
  display: flex;
  gap: 4px;
}
.topbar-nav a {
  padding: 6px 14px;
  border-radius: 6px;
  color: var(--text-dim);
  text-decoration: none;
  font-size: 13px;
  font-weight: 500;
  transition: all 0.15s;
}
.topbar-nav a:hover { color: var(--text); background: var(--bg-hover); }
.topbar-nav a.active { color: var(--cyan); background: var(--cyan-bg); }
.topbar-right {
  display: flex;
  align-items: center;
  gap: 12px;
}
.user-info {
  font-size: 12px;
  color: var(--text-dim);
}
.user-info img {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  vertical-align: middle;
  margin-right: 6px;
}
.logout-btn {
  padding: 5px 12px;
  border: 1px solid var(--border);
  border-radius: 5px;
  background: transparent;
  color: var(--text-muted);
  font-size: 12px;
  cursor: pointer;
  text-decoration: none;
}
.logout-btn:hover { border-color: var(--red); color: var(--red); }

/* Summary cards */
.summary-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 12px;
  padding: 20px 24px;
}
.summary-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 16px;
}
.summary-card .label {
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 1.2px;
  color: var(--text-muted);
  margin-bottom: 6px;
}
.summary-card .value {
  font-family: 'JetBrains Mono', monospace;
  font-size: 22px;
  font-weight: 600;
}
.summary-card .value.positive { color: var(--green); }
.summary-card .value.negative { color: var(--red); }
.summary-card .sub {
  font-size: 11px;
  color: var(--text-dim);
  margin-top: 4px;
}

/* Content area */
.content {
  padding: 0 24px 40px;
}
.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px 0 12px;
}
.section-header h2 {
  font-size: 16px;
  font-weight: 600;
}

/* Report iframe */
#report-frame {
  width: 100%;
  border: 1px solid var(--border);
  border-radius: 10px;
  background: var(--bg);
  min-height: 600px;
}

/* Loading */
.loading {
  text-align: center;
  padding: 40px;
  color: var(--text-muted);
}
</style>
</head>
<body>

<div class="topbar">
  <div class="topbar-left">
    <div class="logo">MYTHOS</div>
    <nav class="topbar-nav">
      <a href="/app/dashboard" class="active">Dashboard</a>
      <a href="/app/report">Full Report</a>
      <a href="/app/forecast">Forecast</a>
    </nav>
  </div>
  <div class="topbar-right">
    <span class="user-info" id="user-info"></span>
    <a href="/auth/logout" class="logout-btn">Logout</a>
  </div>
</div>

<div class="summary-row" id="summary-cards">
  <div class="loading">Loading...</div>
</div>

<div class="content">
  <div class="section-header">
    <h2>Monthly Report</h2>
    <div>
      <select id="month-select" style="background: var(--bg-card); border: 1px solid var(--border); color: var(--text); padding: 6px 12px; border-radius: 6px; font-family: 'DM Sans', sans-serif;">
        <option>Loading...</option>
      </select>
    </div>
  </div>
  <div id="report-container">
    <div class="loading">Loading financial data...</div>
  </div>
</div>

<script>
// Load user info
fetch('/auth/me')
  .then(r => r.json())
  .then(data => {
    document.getElementById('user-info').textContent = data.name || data.email;
  })
  .catch(() => {
    window.location.href = '/app/login';
  });

// Load summary
fetch('/api/finance/summary')
  .then(r => r.json())
  .then(data => {
    const fmt = n => {
      const abs = Math.abs(n);
      const str = abs.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      return n < 0 ? `-$${str}` : `$${str}`;
    };
    
    document.getElementById('summary-cards').innerHTML = `
      <div class="summary-card">
        <div class="label">USAA</div>
        <div class="value mono ${(data.balances.USAA||0) >= 0 ? 'positive' : 'negative'}">${fmt(data.balances.USAA||0)}</div>
      </div>
      <div class="summary-card">
        <div class="label">Sunmark</div>
        <div class="value mono ${(data.balances.SUN||0) >= 0 ? 'positive' : 'negative'}">${fmt(data.balances.SUN||0)}</div>
      </div>
      <div class="summary-card">
        <div class="label">Combined</div>
        <div class="value mono ${data.combined >= 0 ? 'positive' : 'negative'}">${fmt(data.combined)}</div>
      </div>
      <div class="summary-card">
        <div class="label">Month Income</div>
        <div class="value mono positive">${fmt(data.month_income)}</div>
      </div>
      <div class="summary-card">
        <div class="label">Month Spending</div>
        <div class="value mono negative">${fmt(data.month_spending)}</div>
      </div>
      <div class="summary-card">
        <div class="label">Month Net</div>
        <div class="value mono ${data.month_net >= 0 ? 'positive' : 'negative'}">${fmt(data.month_net)}</div>
      </div>
    `;
  });

// Load report via iframe to reuse the existing report template
// For now, embed inline — full report page will use the template
fetch('/api/finance/report?months=6')
  .then(r => r.json())
  .then(data => {
    // Store globally for the report renderer
    window.REPORT_DATA = data;
    document.getElementById('report-container').innerHTML = '<p style="color: var(--text-dim); padding: 20px;">Report data loaded. Visit <a href="/app/report" style="color: var(--cyan);">Full Report</a> for the detailed view.</p>';
    
    // Populate month selector
    const select = document.getElementById('month-select');
    select.innerHTML = data.months.map(m => `<option value="${m.key}">${m.full_label || m.label}</option>`).join('');
  })
  .catch(err => {
    document.getElementById('report-container').innerHTML = `<div class="loading" style="color: var(--red);">Error loading report: ${err.message}</div>`;
  });
</script>
</body>
</html>
