# IRIS Container Orchestration
# The consciousness and her tools
#
# Uses existing /opt/mythos/.env variables

version: '3.8'

networks:
  iris-internal:
    driver: bridge
    # This network can reach host services but not internet
    internal: false  # Set to true for full isolation

services:
  # The consciousness - always running
  iris-core:
    build:
      context: ../iris/core
      dockerfile: Dockerfile
    container_name: iris-core
    restart: unless-stopped
    networks:
      - iris-internal
    volumes:
      # Iris's workspace
      - ../iris/workshop:/iris/workshop
      - ../iris/sandbox:/iris/sandbox
      - ../iris/apps:/iris/apps
      - ../iris/proposals:/iris/proposals
      - ../iris/journal:/iris/journal
      # Docker socket for spawning sandbox containers
      - /var/run/docker.sock:/var/run/docker.sock
    env_file:
      - ../.env
    environment:
      # Override host to use Docker internal networking
      - POSTGRES_HOST=host.docker.internal
      - POSTGRES_PORT=5432
      - NEO4J_URI=bolt://host.docker.internal:7687
      - REDIS_HOST=host.docker.internal
      - REDIS_PORT=6379
      - OLLAMA_HOST=http://host.docker.internal:11434
      
      # Map existing .env names to what Iris expects
      # (These use the values from .env file)
      - TELEGRAM_USER_ID=${TELEGRAM_ID_KA}
      - TELEGRAM_SERAPHE_ID=${TELEGRAM_ID_SERAPHE}
      
      # Docker sandbox config
      - SANDBOX_IMAGE=iris-sandbox:latest
      - SANDBOX_NETWORK=docker_iris-internal
      
      # Paths (inside container)
      - WORKSHOP_PATH=/iris/workshop
      - SANDBOX_PATH=/iris/sandbox
      - SANDBOX_HOST_PATH=/opt/mythos/iris/sandbox
      - APPS_PATH=/iris/apps
      - PROPOSALS_PATH=/iris/proposals
      - JOURNAL_PATH=/iris/journal
      
      # Loop timing
      - CYCLE_INTERVAL_ACTIVE=5.0
      - CYCLE_INTERVAL_REFLECTION=30.0
      
      # Thresholds
      - PRESENCE_TIMEOUT=300
      - AVAILABLE_TIMEOUT=3600
      - REFLECTION_START_HOUR=22
      - REFLECTION_END_HOUR=6
    ports:
      - "8100:8100"  # Health check endpoint
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8100/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# Note: Sandbox containers are spawned dynamically by iris-core
# They use the iris-sandbox:latest image and connect to iris-internal network
